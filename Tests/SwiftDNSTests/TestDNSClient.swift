//
//  TestDNSClient.swift
//  SwiftDNS
//
//  Created by mtzfederico on 2025-08-20
//â€¨

import Testing
import Foundation
@testable import SwiftDNS

struct TestDNSClient {
    @Test func query_A() throws {
        let expectedFlags = DNSHeader.DNSFlags(qr: 0, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        
        let expectedHeader = DNSHeader(id: 0x7643, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 0, ARCOUNT: 0)
        
        // 0 0000 0 0 1 0 000 0000
        let rawFlags: UInt16 = 0x100
        let parsedFlags = try DNSHeader.DNSFlags(from: rawFlags)
        
        #expect(parsedFlags == expectedFlags)
        
        // 76 43
        // 01 00
        // 00 01
        // 00 00
        // 00 00
        // 00 00
        // 08 61 73 32 30 39 32 34 35
        // 03 6e 65 74 00
        // 00 01
        // 00 01
        
        let data: Data = Data([
            0x76, 0x43,  // Transaction ID
            0x01, 0x00,  // Flags (QR=0, Opcode=0, AA=0, TC=0, RD=1, RA=0, Z=000, RCODE=0) --> 0 0000 0 0 1 0 000 0000
            0x00, 0x01,  // QDCOUNT (1 question)
            0x00, 0x00,  // ANCOUNT (0 answers)
            0x00, 0x00,  // NSCOUNT (0 authority records)
            0x00, 0x00,  // ARCOUNT (0 additional records)
            
            // QNAME (example.com)
            0x08, 0x61, 0x73, 0x32, 0x30, 0x39, 0x32, 0x34,  // "as209245"
            0x35, 0x03, 0x6e, 0x65,  // "net"
            0x74, 0x00, // End of QNAME
            
            0x00, 0x01,  // QTYPE (A record)
            0x00, 0x01   // QCLASS (IN class)
        ])
        
        
        var offset = 0
        let parsedHeader = try DNSHeader(data: data, offset: &offset)
        
        #expect(parsedHeader == expectedHeader)
        
        // -------
        
        let expectedQuestion = QuestionSection(host: "as209245.net", type: .A, CLASS: .internet)
        let fullData = expectedHeader.toData() + expectedQuestion.toData()
        
        #expect(fullData == data)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func query_AAAA() throws {
        let expectedFlags = DNSHeader.DNSFlags(qr: 0, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        let expectedHeader = DNSHeader(id: 0xa17c, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 0, ARCOUNT: 0)
        
        // 0 0000 0 0 1 0 000 0000
        let rawFlags: UInt16 = 0x100
        let parsedFlags = try DNSHeader.DNSFlags(from: rawFlags)
        
        #expect(parsedFlags == expectedFlags)
        
        let data = Data([
            0xa1, 0x7c,  // [0-1]   ID = a17c
            0x01, 0x00,  // [2-3]   Flags
            0x00, 0x01,  // [4-5]   QDCOUNT = 1
            0x00, 0x00,  // [6-7]   ANCOUNT = 0
            0x00, 0x00,  // [8-9]   NSCOUNT = 0
            0x00, 0x00,  // [10-11] ARCOUNT = 0
            0x0a, 0x62, 0x61, 0x6e, 0x64, 0x61, 0x61, 0x6e, 0x63, 0x68, 0x61, // [12-22] Label "bandaancha"
            0x02, 0x65, 0x75,             // [23-25] Label "eu"
            0x00,                         // [26]    End of QNAME
            0x00, 0x1c,                   // [27-28] QTYPE (AAAA)
            0x00, 0x01                    // [29-30] QCLASS (IN)
        ])
        
        var offset = 0
        let parsedHeader = try DNSHeader(data: data, offset: &offset)
        
        #expect(parsedHeader == expectedHeader)
        
        // -------
        
        let expectedQuestion = QuestionSection(host: "bandaancha.eu", type: .AAAA, CLASS: .internet)
        let fullData = expectedHeader.toData() + expectedQuestion.toData()
        
        #expect(fullData == data)
        
        // print("expectedHeader: \(expectedHeader.toData().hexEncodedString())\nexpectedQuestion: \(expectedQuestion.toData().hexEncodedString())\nfullData: \(fullData.hexEncodedString())\ndata: \(data.hexEncodedString())")
    }
    
    @Test func query_CH_TXT() throws {
        let expectedFlags = DNSHeader.DNSFlags(qr: 0, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        
        let expectedHeader = DNSHeader(id: 0x5ef4, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 0, ARCOUNT: 0)
        
        // 0 0000 0 0 1 0 000 0000
        let rawFlags: UInt16 = 0x100
        let parsedFlags = try DNSHeader.DNSFlags(from: rawFlags)
        
        #expect(parsedFlags == expectedFlags)
        
        let data = Data([
            0x5e, 0xf4,   // [0-1]   ID
            0x01, 0x00,   // [2-3]   Flags
            0x00, 0x01,   // [4-5]   QDCOUNT
            0x00, 0x00,   // [6-7]   ANCOUNT
            0x00, 0x00,   // [8-9]   NSCOUNT
            0x00, 0x00,   // [10-11] ARCOUNT
            0x02, 0x69, 0x64, 0x06, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, // [12-25] Label "id" and Label "server"
            0x00,         // [26]    End of QNAME
            0x00, 0x10,   // [27-28] QTYPE (TXT)
            0x00, 0x03    // [29-30] QCLASS (CH)
        ])
        
        var offset = 0
        let parsedHeader = try DNSHeader(data: data, offset: &offset)
        
        #expect(parsedHeader == expectedHeader)
        
        // -------
        
        let expectedQuestion = QuestionSection(host: "id.server", type: .TXT, CLASS: .chaos)
        let fullData = expectedHeader.toData() + expectedQuestion.toData()
        
        #expect(fullData == data)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func ptr0() throws {
        let expectedFlags = DNSHeader.DNSFlags(qr: 0, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x8b3a, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 0, ARCOUNT: 0)
        
        // 0 0000 0 0 1 0 000 0000
        let rawFlags: UInt16 = 0x100
        let parsedFlags = try DNSHeader.DNSFlags(from: rawFlags)
        
        #expect(parsedFlags == expectedFlags)
        
        // 8b3a01000001000000000000023334023438033231300331383907696e2d61646472046172706100000c0001

        let data: Data = Data([
            0x8b, 0x3a, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x02, 0x33, 0x34, 0x02, 0x34, 0x38, 0x03, 0x32, 0x31, 0x30, 0x03, 0x31,
            0x38, 0x39, 0x07, 0x69, 0x6e, 0x2d, 0x61, 0x64, 0x64, 0x72, 0x04, 0x61,
            0x72, 0x70, 0x61, 0x00, 0x00, 0x0c, 0x00, 0x01,
        ])
        
        var offset = 0
        let parsedHeader = try DNSHeader(data: data, offset: &offset)
        
        #expect(parsedHeader == expectedHeader)
        
        // -------
        
        let expectedQuestion = QuestionSection(host: "34.48.210.189.in-addr.arpa", type: .PTR, CLASS: .internet)
        let fullData = expectedHeader.toData() + expectedQuestion.toData()
        
        #expect(fullData == data)
        
        // print("expectedHeader: \(expectedHeader.toData().hexEncodedString())\nexpectedQuestion: \(expectedQuestion.toData().hexEncodedString())\nfullData: \(fullData.hexEncodedString())\ndata: \(data.hexEncodedString())")
    }
    
    @Test func ptr1() throws {
        let expectedFlags = DNSHeader.DNSFlags(qr: 0, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x7d5c, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 0, ARCOUNT: 0)
        
        // 0 0000 0 0 1 0 000 0000
        let rawFlags: UInt16 = 0x100
        let parsedFlags = try DNSHeader.DNSFlags(from: rawFlags)
        
        #expect(parsedFlags == expectedFlags)
        
        
        // 7d5c010000010000000000000131013001300130013001300130013001300130013001300130013001300130013001300130013001370166016601660130016301320166013101310161013203697036046172706100000c0001
        
        let data = Data([
            0x7d, 0x5c, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x31, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x37, 0x01, 0x66, 0x01, 0x66, 0x01, 0x66,
            0x01, 0x30, 0x01, 0x63, 0x01, 0x32, 0x01, 0x66, 0x01, 0x31, 0x01, 0x31,
            0x01, 0x61, 0x01, 0x32, 0x03, 0x69, 0x70, 0x36, 0x04, 0x61, 0x72, 0x70,
            0x61, 0x00, 0x00, 0x0c, 0x00, 0x01
        ])
        
        var offset = 0
        let parsedHeader = try DNSHeader(data: data, offset: &offset)
        
        #expect(parsedHeader == expectedHeader)
        
        // -------
        
        let expectedQuestion = QuestionSection(host: "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.7.f.f.f.0.c.2.f.1.1.a.2.ip6.arpa.", type: .PTR, CLASS: .internet)
        let fullData = expectedHeader.toData() + expectedQuestion.toData()
        
        #expect(fullData == data)
        
        // print("expectedHeader: \(expectedHeader.toData().hexEncodedString())\nexpectedQuestion: \(expectedQuestion.toData().hexEncodedString())\nfullData: \(fullData.hexEncodedString())\ndata: \(data.hexEncodedString())")
    }
    
    // MARK: Responses
    
    @Test func multi_aaaa_response() throws {
        // 42d281800001000200000000086173323039323435036e657400001c0001c00c001c00010000001a001026064700303100000000000068155ad2c00c001c00010000001a0010260647003037000000000000ac43a168
        
        let data = Data([
            0x42, 0xd2, 0x81, 0x80, 0x00, 0x01, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
            0x08, 0x61, 0x73, 0x32, 0x30, 0x39, 0x32, 0x34, 0x35, 0x03, 0x6e, 0x65,
            0x74, 0x00, 0x00, 0x1c, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x00, 0x00, 0x1a, 0x00, 0x10, 0x26, 0x06, 0x47, 0x00, 0x30, 0x31,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x15, 0x5a, 0xd2, 0xc0, 0x0c,
            0x00, 0x1c, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x10, 0x26, 0x06,
            0x47, 0x00, 0x30, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xac, 0x43,
            0xa1, 0x68
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        // -------
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 1, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x42d2, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 2, NSCOUNT: 0, ARCOUNT: 0)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 2)
        #expect(parsedAnswer.Authority.count == 0)
        #expect(parsedAnswer.Additional.count == 0)
        
        let expectedQuestion = QuestionSection(host: "as209245.net", type: .AAAA, CLASS: .internet)
        
        let expectedAnswer0 = ResourceRecord(name: "as209245.net", ttl: 26, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2606:4700:3031:0:0:0:6815:5ad2")
        let expectedAnswer1 = ResourceRecord(name: "as209245.net", ttl: 26, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2606:4700:3037:0:0:0:ac43:a168")
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        #expect(firstQuestion == expectedQuestion)
        #expect(parsedAnswer.Answer[0] == expectedAnswer0)
        #expect(parsedAnswer.Answer[1] == expectedAnswer1)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func ptr0_response() throws {
        let data = Data([
            0x8b, 0x3a,             // ID
            0x81, 0x80,             // Flags (standard response, no error)
            0x00, 0x01,             // QDCOUNT = 1
            0x00, 0x01,             // ANCOUNT = 1
            0x00, 0x00,             // NSCOUNT = 0
            0x00, 0x00,             // ARCOUNT = 0
            
            // QNAME: 334.48.210.189.in-addr.arpa
            0x02, 0x33, 0x34,       // label: "34"
            0x02, 0x34, 0x38,       // label: "48"
            0x03, 0x32, 0x31, 0x30, // label: "210"
            0x03, 0x31, 0x38, 0x39, // label: "189"
            0x07, 0x69, 0x6e, 0x2d, 0x61, 0x64, 0x64, 0x72, // label: "in-addr"
            0x04, 0x61, 0x72, 0x70, 0x61, // label: "arpa"
            0x00,                   // end of QNAME
            
            0x00, 0x0c,             // QTYPE = PTR
            0x00, 0x01,             // QCLASS = IN
            
            // Answer section
            0xc0, 0x0c,             // NAME (pointer to offset 12)
            0x00, 0x0c,             // TYPE = PTR
            0x00, 0x01,             // CLASS = IN
            0x00, 0x00, 0x0b, 0x44, // TTL = 2884
            0x00, 0x20,             // RDLENGTH = 32
            
            // RDATA: 189-210-48-34.static.axtel.net
            0x0d, 0x31, 0x38, 0x39, 0x2d, 0x32, 0x31, 0x30, 0x2d, 0x34, 0x38, 0x2d, 0x33, 0x34, // "189-210-48-34"
            0x06, 0x73, 0x74, 0x61, 0x74, 0x69, 0x63,       // "static"
            0x05, 0x61, 0x78, 0x74, 0x65, 0x6c,             // "axtel"
            0x03, 0x6e, 0x65, 0x74,                         // "net"
            0x00                                            // end of name
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        // -------
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 1, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x8b3a, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 1, NSCOUNT: 0, ARCOUNT: 0)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 1)
        #expect(parsedAnswer.Authority.count == 0)
        #expect(parsedAnswer.Additional.count == 0)
        
        let expectedQuestion = QuestionSection(host: "34.48.210.189.in-addr.arpa", type: .PTR, CLASS: .internet)
        
        // as209245.net.        1800    IN    SOA    josh.ns.cloudflare.com. dns.cloudflare.com. 2379358730 10000 2400 604800 1800
        let expectedAnswer = ResourceRecord(name: "34.48.210.189.in-addr.arpa", ttl: 2884, Class: DNSClass.internet, type: DNSRecordType.PTR, value: "189-210-48-34.static.axtel.net")
        
        guard let firstAnswer = parsedAnswer.Answer.first else {
            Issue.record("First answer is nil")
            return
        }
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        #expect(firstAnswer == expectedAnswer)
        #expect(firstQuestion == expectedQuestion)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func ptr1_response() throws {
        // 7d5c818000010001000000000131013001300130013001300130013001300130013001300130013001300130013001300130013001370166016601660130016301320166013101310161013203697036046172706100000c0001c00c000c000100000e10001905656467653004616d7330086173323039323435036e657400
        
        let data = Data([
            0x7d, 0x5c, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x31, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30, 0x01, 0x30,
            0x01, 0x30, 0x01, 0x30, 0x01, 0x37, 0x01, 0x66, 0x01, 0x66, 0x01, 0x66,
            0x01, 0x30, 0x01, 0x63, 0x01, 0x32, 0x01, 0x66, 0x01, 0x31, 0x01, 0x31,
            0x01, 0x61, 0x01, 0x32, 0x03, 0x69, 0x70, 0x36, 0x04, 0x61, 0x72, 0x70,
            0x61, 0x00, 0x00, 0x0c, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x0c, 0x00, 0x01,
            0x00, 0x00, 0x0e, 0x10, 0x00, 0x19, 0x05, 0x65, 0x64, 0x67, 0x65, 0x30,
            0x04, 0x61, 0x6d, 0x73, 0x30, 0x08, 0x61, 0x73, 0x32, 0x30, 0x39, 0x32,
            0x34, 0x35, 0x03, 0x6e, 0x65, 0x74, 0x00
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        // -------
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 1, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x7d5c, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 1, NSCOUNT: 0, ARCOUNT: 0)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 1)
        #expect(parsedAnswer.Authority.count == 0)
        #expect(parsedAnswer.Additional.count == 0)
        
        let expectedQuestion = QuestionSection(host: "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.7.f.f.f.0.c.2.f.1.1.a.2.ip6.arpa", type: .PTR, CLASS: .internet)
        
        // as209245.net.        1800    IN    SOA    josh.ns.cloudflare.com. dns.cloudflare.com. 2379358730 10000 2400 604800 1800
        let expectedAnswer = ResourceRecord(name: "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.7.f.f.f.0.c.2.f.1.1.a.2.ip6.arpa", ttl: 3600, Class: DNSClass.internet, type: DNSRecordType.PTR, value: "edge0.ams0.as209245.net")
        
        guard let firstAnswer = parsedAnswer.Answer.first else {
            Issue.record("First answer is nil")
            return
        }
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        #expect(firstAnswer == expectedAnswer)
        #expect(firstQuestion == expectedQuestion)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func srv_response() throws {
        // 9e16818000010001000000000a5f6d696e656372616674045f74637009666564656d747a363604746563680000210001c00c002100010000012c001c0001000163dc056466772d3109666564656d747a3636047465636800

        let data: Data = Data([
            0x9e, 0x16, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x0a, 0x5f, 0x6d, 0x69, 0x6e, 0x65, 0x63, 0x72, 0x61, 0x66, 0x74, 0x04,
            0x5f, 0x74, 0x63, 0x70, 0x09, 0x66, 0x65, 0x64, 0x65, 0x6d, 0x74, 0x7a,
            0x36, 0x36, 0x04, 0x74, 0x65, 0x63, 0x68, 0x00, 0x00, 0x21, 0x00, 0x01,
            0xc0, 0x0c, 0x00, 0x21, 0x00, 0x01, 0x00, 0x00, 0x01, 0x2c, 0x00, 0x1c,
            0x00, 0x01, 0x00, 0x01, 0x63, 0xdc, 0x05, 0x64, 0x66, 0x77, 0x2d, 0x31,
            0x09, 0x66, 0x65, 0x64, 0x65, 0x6d, 0x74, 0x7a, 0x36, 0x36, 0x04, 0x74,
            0x65, 0x63, 0x68, 0x00,
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        // -------
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 1, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x9e16, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 1, NSCOUNT: 0, ARCOUNT: 0)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 1)
        #expect(parsedAnswer.Authority.count == 0)
        #expect(parsedAnswer.Additional.count == 0)
        
        let expectedQuestion = QuestionSection(host: "_minecraft._tcp.fedemtz66.tech", type: .SRV, CLASS: .internet)
        
        // _minecraft._tcp.fedemtz66.tech.    300 IN    SRV    1 1 25564 dfw-1.fedemtz66.tech.
        let expectedAnswer = ResourceRecord(name: "_minecraft._tcp.fedemtz66.tech", ttl: 300, Class: DNSClass.internet, type: DNSRecordType.SRV, value: "1 1 25564 dfw-1.fedemtz66.tech")
        
        guard let firstAnswer = parsedAnswer.Answer.first else {
            Issue.record("First answer is nil")
            return
        }
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        #expect(firstAnswer == expectedAnswer)
        #expect(firstQuestion == expectedQuestion)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    @Test func nxDomainResponse() throws {
        let data: Data = Data([
            0x3e, 0xa9, 0x81, 0x80, 0x00, 0x01, 0x00, 0x00,
            0x00, 0x01, 0x00, 0x00, 0x08, 0x6e, 0x78, 0x64,
            0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x08, 0x61, 0x73,
            0x32, 0x30, 0x39, 0x32, 0x34, 0x35, 0x03, 0x6e,
            0x65, 0x74, 0x00, 0x00, 0x01, 0x00, 0x01, 0xc0,
            0x15, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x07,
            0x08, 0x00, 0x32, 0x04, 0x6a, 0x6f, 0x73, 0x68,
            0x02, 0x6e, 0x73, 0x0a, 0x63, 0x6c, 0x6f, 0x75,
            0x64, 0x66, 0x6c, 0x61, 0x72, 0x65, 0x03, 0x63,
            0x6f, 0x6d, 0x00, 0x03, 0x64, 0x6e, 0x73, 0xc0,
            0x3b, 0x8d, 0xd2, 0x22, 0x0a, 0x00, 0x00, 0x27,
            0x10, 0x00, 0x00, 0x09, 0x60, 0x00, 0x09, 0x3a,
            0x80, 0x00, 0x00, 0x07, 0x08
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        // -------
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 1, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x3EA9, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 1, ARCOUNT: 0)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 0)
        #expect(parsedAnswer.Authority.count == 1)
        #expect(parsedAnswer.Additional.count == 0)
        
        
        let expectedQuestion = QuestionSection(host: "nxdomain.as209245.net", type: .A, CLASS: .internet)
        
        // as209245.net.        1800    IN    SOA    josh.ns.cloudflare.com. dns.cloudflare.com. 2379358730 10000 2400 604800 1800
        let expectedAnswer = ResourceRecord(name: "as209245.net", ttl: 1800, Class: DNSClass.internet, type: DNSRecordType.SOA, value: "josh.ns.cloudflare.com dns.cloudflare.com 2379358730 10000 2400 604800 1800")
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        guard let firstAuthority = parsedAnswer.Authority.first else {
            Issue.record("First authority is nil")
            return
        }
        
        #expect(firstQuestion == expectedQuestion)
        #expect(firstAuthority == expectedAnswer)
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    /// Response from a server pointing to the ns to query
    @Test func notAuthoritative() throws {
        // k.root-servers.net    193.0.14.129, 2001:7fd::1    RIPE NCC
        
        let data: Data = Data([
            0x78, 0x2c, 0x81, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x1a,
            0x08, 0x61, 0x73, 0x32, 0x30, 0x39, 0x32, 0x34, 0x35, 0x03, 0x6e, 0x65,
            0x74, 0x00, 0x00, 0x1c, 0x00, 0x01, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x14, 0x01, 0x61, 0x0c, 0x67, 0x74, 0x6c,
            0x64, 0x2d, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, 0x73, 0x03, 0x6e, 0x65,
            0x74, 0x00, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0x01, 0x69, 0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x6a, 0xc0, 0x2c, 0xc0, 0x15,
            0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x62,
            0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0x01, 0x6c, 0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x6d, 0xc0, 0x2c, 0xc0, 0x15,
            0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x65,
            0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0x01, 0x64, 0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x68, 0xc0, 0x2c, 0xc0, 0x15,
            0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x66,
            0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0x01, 0x67, 0xc0, 0x2c, 0xc0, 0x15, 0x00, 0x02, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x63, 0xc0, 0x2c, 0xc0, 0x15,
            0x00, 0x02, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0x01, 0x6b,
            0xc0, 0x2c, 0xc0, 0x8a, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0xc0, 0x37, 0x53, 0x1e, 0xc0, 0x7a, 0x00, 0x01, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x29, 0xa2, 0x1e, 0xc0, 0xfa,
            0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x34,
            0xb2, 0x1e, 0xc0, 0x5a, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0xc0, 0x30, 0x4f, 0x1e, 0xc0, 0x4a, 0x00, 0x01, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x2b, 0xac, 0x1e, 0xc0, 0xba,
            0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x36,
            0x70, 0x1e, 0xc0, 0xda, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0xc0, 0x2a, 0x5d, 0x1e, 0xc0, 0xca, 0x00, 0x01, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x23, 0x33, 0x1e, 0xc0, 0x9a,
            0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x0c,
            0x5e, 0x1e, 0xc0, 0xaa, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0xc0, 0x1f, 0x50, 0x1e, 0xc0, 0xea, 0x00, 0x01, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x1a, 0x5c, 0x1e, 0xc0, 0x6a,
            0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x04, 0xc0, 0x21,
            0x0e, 0x1e, 0xc0, 0x2a, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x04, 0xc0, 0x05, 0x06, 0x1e, 0xc0, 0x8a, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01, 0x05, 0x01, 0xb1, 0xf9,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x7a,
            0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01,
            0x05, 0x00, 0xd9, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x30, 0xc0, 0xfa, 0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x10, 0x20, 0x01, 0x05, 0x03, 0x0d, 0x2d, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x5a, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01, 0x05, 0x02, 0x70, 0x94,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x4a,
            0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01,
            0x05, 0x03, 0x39, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x30, 0xc0, 0xba, 0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x10, 0x20, 0x01, 0x05, 0x02, 0x08, 0xcc, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0xda, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01, 0x05, 0x03, 0xee, 0xa3,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0xca,
            0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01,
            0x05, 0x03, 0xd4, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x30, 0xc0, 0x9a, 0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x10, 0x20, 0x01, 0x05, 0x02, 0x1c, 0xa1, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0xaa, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01, 0x05, 0x00, 0x85, 0x6e,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0xea,
            0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01,
            0x05, 0x03, 0x83, 0xeb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x30, 0xc0, 0x6a, 0x00, 0x1c, 0x00, 0x01, 0x00, 0x02, 0xa3, 0x00,
            0x00, 0x10, 0x20, 0x01, 0x05, 0x03, 0x23, 0x1d, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x02, 0x00, 0x30, 0xc0, 0x2a, 0x00, 0x1c, 0x00, 0x01,
            0x00, 0x02, 0xa3, 0x00, 0x00, 0x10, 0x20, 0x01, 0x05, 0x03, 0xa8, 0x3e,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x30,
        ])
        
        let parsedAnswer = try DNSClient.parseDNSResponse(data)
        
        let expectedFlags = DNSHeader.DNSFlags(qr: 1, opcode: 0, aa: 0, tc: 0, rd: 1, ra: 0, rcode: 0)
        let expectedHeader = DNSHeader(id: 0x782c, flags: expectedFlags, QDCOUNT: 1, ANCOUNT: 0, NSCOUNT: 13, ARCOUNT: 26)
        
        #expect(parsedAnswer.header == expectedHeader)
        
        #expect(parsedAnswer.Question.count == 1)
        #expect(parsedAnswer.Answer.count == 0)
        #expect(parsedAnswer.Authority.count == 13)
        #expect(parsedAnswer.Additional.count == 26)
        
        
        let expectedQuestion = QuestionSection(host: "as209245.net", type: .AAAA, CLASS: .internet)
        
        guard let firstQuestion = parsedAnswer.Question.first else {
            Issue.record("First question is nil")
            return
        }
        
        #expect(firstQuestion == expectedQuestion)
        
        let expectedNS: [ResourceRecord] = [
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "a.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "i.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "j.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "b.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "l.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "m.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "e.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "d.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "h.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "f.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "g.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "c.gtld-servers.net"),
            ResourceRecord(name: "net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.NS, value: "k.gtld-servers.net"),
        ]
        
        for i in 0..<parsedAnswer.Authority.count {
            #expect(expectedNS[i] == parsedAnswer.Authority[i])
        }
        
        let expectedAR: [ResourceRecord] = [
            ResourceRecord(name: "m.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.55.83.30"),
            ResourceRecord(name: "l.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.41.162.30"),
            ResourceRecord(name: "k.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.52.178.30"),
            ResourceRecord(name: "j.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.48.79.30"),
            ResourceRecord(name: "i.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.43.172.30"),
            ResourceRecord(name: "h.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.54.112.30"),
            ResourceRecord(name: "g.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.42.93.30"),
            ResourceRecord(name: "f.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.35.51.30"),
            ResourceRecord(name: "e.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.12.94.30"),
            ResourceRecord(name: "d.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.31.80.30"),
            ResourceRecord(name: "c.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.26.92.30"),
            ResourceRecord(name: "b.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.33.14.30"),
            ResourceRecord(name: "a.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.A, value: "192.5.6.30"),
            
            ResourceRecord(name: "m.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:501:b1f9:0:0:0:0:30"),
            ResourceRecord(name: "l.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:500:d937:0:0:0:0:30"),
            ResourceRecord(name: "k.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:d2d:0:0:0:0:30"),
            ResourceRecord(name: "j.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:502:7094:0:0:0:0:30"),
            ResourceRecord(name: "i.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:39c1:0:0:0:0:30"),
            ResourceRecord(name: "h.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:502:8cc:0:0:0:0:30"),
            ResourceRecord(name: "g.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:eea3:0:0:0:0:30"),
            ResourceRecord(name: "f.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:d414:0:0:0:0:30"),
            ResourceRecord(name: "e.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:502:1ca1:0:0:0:0:30"),
            ResourceRecord(name: "d.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:500:856e:0:0:0:0:30"),
            ResourceRecord(name: "c.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:83eb:0:0:0:0:30"),
            ResourceRecord(name: "b.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:231d:0:0:0:2:30"),
            ResourceRecord(name: "a.gtld-servers.net", ttl: 172800, Class: DNSClass.internet, type: DNSRecordType.AAAA, value: "2001:503:a83e:0:0:0:2:30"),
        ]
        
        for i in 0..<parsedAnswer.Additional.count {
            #expect(expectedAR[i] == parsedAnswer.Additional[i])
        }
        
        // print("fullData: \(fullData.hexEncodedString())\n\ndata: \(data.hexEncodedString())")
    }
    
    // MARK: Invalid Responses
    
    @Test func receivedHTML() throws {
        // https://google.com/teapot
        
        let data: Data = Data([
            0x3c, 0x21, 0x64, 0x6f, 0x63, 0x74, 0x79, 0x70, 0x65, 0x20, 0x68, 0x74,
            0x6d, 0x6c, 0x3e, 0x3c, 0x68, 0x74, 0x6d, 0x6c, 0x20, 0x6c, 0x61, 0x6e,
            0x67, 0x3d, 0x22, 0x65, 0x6e, 0x22, 0x3e, 0x20, 0x3c, 0x73, 0x63, 0x72,
            0x69, 0x70, 0x74, 0x20, 0x6e, 0x6f, 0x6e, 0x63, 0x65, 0x3d, 0x22, 0x66,
            0x30, 0x47, 0x44, 0x4e, 0x6b, 0x6d, 0x32, 0x6c, 0x76, 0x77, 0x61, 0x5f,
            0x4c, 0x66, 0x6a, 0x46, 0x67, 0x57, 0x77, 0x4c, 0x77, 0x22, 0x3e, 0x28,
            0x66, 0x75, 0x6e, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x28, 0x48, 0x29, 0x7b,
            0x48, 0x2e, 0x63, 0x6c, 0x61, 0x73, 0x73, 0x4e, 0x61, 0x6d, 0x65, 0x3d,
            0x48, 0x2e, 0x63, 0x6c, 0x61, 0x73, 0x73, 0x4e, 0x61, 0x6d, 0x65, 0x2e,
            0x72, 0x65, 0x70, 0x6c, 0x61, 0x63, 0x65, 0x28, 0x2f, 0x5c, 0x62, 0x67,
            0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x5c, 0x62, 0x2f, 0x2c, 0x27, 0x67, 0x6f,
            0x6f, 0x67, 0x6c, 0x65, 0x2d, 0x6a, 0x73, 0x27, 0x29, 0x7d, 0x29, 0x28,
            0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x64, 0x6f, 0x63,
            0x75, 0x6d, 0x65, 0x6e, 0x74, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74,
            0x29, 0x3c, 0x2f, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x3e, 0x20, 0x3c,
            0x6d, 0x65, 0x74, 0x61, 0x20, 0x63, 0x68, 0x61, 0x72, 0x73, 0x65, 0x74,
            0x3d, 0x22, 0x75, 0x74, 0x66, 0x2d, 0x38, 0x22, 0x3e, 0x20, 0x3c, 0x6d,
            0x65, 0x74, 0x61, 0x20, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x3d,
            0x22, 0x69, 0x6e, 0x69, 0x74, 0x69, 0x61, 0x6c, 0x2d, 0x73, 0x63, 0x61,
            0x6c, 0x65, 0x3d, 0x31, 0x2c, 0x20, 0x6d, 0x69, 0x6e, 0x69, 0x6d, 0x75,
            0x6d, 0x2d, 0x73, 0x63, 0x61, 0x6c, 0x65, 0x3d, 0x31, 0x2c, 0x20, 0x77,
            0x69, 0x64, 0x74, 0x68, 0x3d, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2d,
            0x77, 0x69, 0x64, 0x74, 0x68, 0x22, 0x20, 0x6e, 0x61, 0x6d, 0x65, 0x3d,
            0x22, 0x76, 0x69, 0x65, 0x77, 0x70, 0x6f, 0x72, 0x74, 0x22, 0x3e, 0x20,
            0x3c, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x3e, 0x45, 0x72, 0x72, 0x6f, 0x72,
            0x20, 0x34, 0x31, 0x38, 0x20, 0x28, 0x49, 0x26, 0x23, 0x38, 0x32, 0x31,
            0x37, 0x3b, 0x6d, 0x20, 0x61, 0x20, 0x74, 0x65, 0x61, 0x70, 0x6f, 0x74,
            0x29, 0x21, 0x3f, 0x3c, 0x2f, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x3e, 0x20,
            0x3c, 0x6c, 0x69, 0x6e, 0x6b, 0x20, 0x68, 0x72, 0x65, 0x66, 0x3d, 0x22,
            0x2f, 0x2f, 0x77, 0x77, 0x77, 0x2e, 0x67, 0x73, 0x74, 0x61, 0x74, 0x69,
            0x63, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x74, 0x65, 0x61, 0x70, 0x6f, 0x74,
            0x2f, 0x74, 0x65, 0x61, 0x70, 0x6f, 0x74, 0x2e, 0x6d, 0x69, 0x6e, 0x2e,
            0x63, 0x73, 0x73, 0x22, 0x20, 0x72, 0x65, 0x6c, 0x3d, 0x22, 0x73, 0x74,
            0x79, 0x6c, 0x65, 0x73, 0x68, 0x65, 0x65, 0x74, 0x22, 0x20, 0x6e, 0x6f,
            0x6e, 0x63, 0x65, 0x3d, 0x22, 0x66, 0x30, 0x47, 0x44, 0x4e, 0x6b, 0x6d,
            0x32, 0x6c, 0x76, 0x77, 0x61, 0x5f, 0x4c, 0x66, 0x6a, 0x46, 0x67, 0x57,
            0x77, 0x4c, 0x77, 0x22, 0x3e, 0x20, 0x3c, 0x61, 0x20, 0x68, 0x72, 0x65,
            0x66, 0x3d, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x77,
            0x77, 0x77, 0x2e, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2e, 0x63, 0x6f,
            0x6d, 0x2f, 0x22, 0x3e, 0x3c, 0x73, 0x70, 0x61, 0x6e, 0x20, 0x61, 0x72,
            0x69, 0x61, 0x2d, 0x6c, 0x61, 0x62, 0x65, 0x6c, 0x3d, 0x22, 0x47, 0x6f,
            0x6f, 0x67, 0x6c, 0x65, 0x22, 0x20, 0x69, 0x64, 0x3d, 0x22, 0x6c, 0x6f,
            0x67, 0x6f, 0x22, 0x3e, 0x3c, 0x2f, 0x73, 0x70, 0x61, 0x6e, 0x3e, 0x3c,
            0x2f, 0x61, 0x3e, 0x20, 0x3c, 0x70, 0x3e, 0x3c, 0x62, 0x3e, 0x34, 0x31,
            0x38, 0x2e, 0x3c, 0x2f, 0x62, 0x3e, 0x20, 0x3c, 0x69, 0x6e, 0x73, 0x3e,
            0x49, 0x26, 0x23, 0x38, 0x32, 0x31, 0x37, 0x3b, 0x6d, 0x20, 0x61, 0x20,
            0x74, 0x65, 0x61, 0x70, 0x6f, 0x74, 0x2e, 0x3c, 0x2f, 0x69, 0x6e, 0x73,
            0x3e, 0x3c, 0x2f, 0x70, 0x3e, 0x20, 0x3c, 0x70, 0x3e, 0x54, 0x68, 0x65,
            0x20, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x65, 0x64, 0x20, 0x65,
            0x6e, 0x74, 0x69, 0x74, 0x79, 0x20, 0x62, 0x6f, 0x64, 0x79, 0x20, 0x69,
            0x73, 0x20, 0x73, 0x68, 0x6f, 0x72, 0x74, 0x20, 0x61, 0x6e, 0x64, 0x20,
            0x73, 0x74, 0x6f, 0x75, 0x74, 0x2e, 0x20, 0x3c, 0x69, 0x6e, 0x73, 0x3e,
            0x54, 0x69, 0x70, 0x20, 0x6d, 0x65, 0x20, 0x6f, 0x76, 0x65, 0x72, 0x20,
            0x61, 0x6e, 0x64, 0x20, 0x70, 0x6f, 0x75, 0x72, 0x20, 0x6d, 0x65, 0x20,
            0x6f, 0x75, 0x74, 0x2e, 0x3c, 0x2f, 0x69, 0x6e, 0x73, 0x3e, 0x3c, 0x2f,
            0x70, 0x3e, 0x20, 0x3c, 0x64, 0x69, 0x76, 0x20, 0x69, 0x64, 0x3d, 0x22,
            0x74, 0x65, 0x61, 0x73, 0x65, 0x74, 0x22, 0x3e, 0x3c, 0x64, 0x69, 0x76,
            0x20, 0x69, 0x64, 0x3d, 0x22, 0x74, 0x65, 0x61, 0x62, 0x6f, 0x74, 0x22,
            0x3e, 0x3c, 0x2f, 0x64, 0x69, 0x76, 0x3e, 0x3c, 0x64, 0x69, 0x76, 0x20,
            0x69, 0x64, 0x3d, 0x22, 0x74, 0x65, 0x61, 0x63, 0x75, 0x70, 0x22, 0x3e,
            0x3c, 0x2f, 0x64, 0x69, 0x76, 0x3e, 0x3c, 0x2f, 0x64, 0x69, 0x76, 0x3e,
            0x20, 0x3c, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x20, 0x73, 0x72, 0x63,
            0x3d, 0x22, 0x2f, 0x2f, 0x77, 0x77, 0x77, 0x2e, 0x67, 0x73, 0x74, 0x61,
            0x74, 0x69, 0x63, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x74, 0x65, 0x61, 0x70,
            0x6f, 0x74, 0x2f, 0x74, 0x65, 0x61, 0x70, 0x6f, 0x74, 0x2e, 0x6d, 0x69,
            0x6e, 0x2e, 0x6a, 0x73, 0x22, 0x20, 0x6e, 0x6f, 0x6e, 0x63, 0x65, 0x3d,
            0x22, 0x66, 0x30, 0x47, 0x44, 0x4e, 0x6b, 0x6d, 0x32, 0x6c, 0x76, 0x77,
            0x61, 0x5f, 0x4c, 0x66, 0x6a, 0x46, 0x67, 0x57, 0x77, 0x4c, 0x77, 0x22,
            0x3e, 0x3c, 0x2f, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x3e, 0x20, 0x3c,
            0x2f, 0x68, 0x74, 0x6d, 0x6c, 0x3e
        ])
        
        #expect(throws: DNSError.invalidData, performing: {
            let _ = try DNSClient.parseDNSResponse(data)
        })
    }
}
